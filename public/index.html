<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tree Storyteller</title>
  <style>
    /* [unchanged styles omitted for brevity] */
  </style>
</head>
<body>
  <div id="tapOverlay">Tap to Begin</div>
  <video id="portal" autoplay muted loop playsinline>
    <source src="magic-vortex-portal.mp4" type="video/mp4" />
  </video>
  <div id="statusText">The Tree is Listening...</div>
  <div id="overlayContainer">
    <div id="overlayText"></div>
  </div>

  <script>
    const statusText = document.getElementById("statusText");
    const overlayText = document.getElementById("overlayText");
    const tapOverlay = document.getElementById("tapOverlay");

    let wakeRecognition = null;
    let promptRecognition = null;
    let voiceAudio = new Audio();
    let thinkingAudio = null;
    let lastThinkingIndex = null;
    let isPrompting = false;
    let isThinking = false;
    let scrollInterval = null;
    let wakeLock = null;

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('ðŸ”‹ Wake Lock released');
          });
          console.log('ðŸ”‹ Wake Lock acquired');
        } catch (err) {
          console.error('Wake Lock error:', err);
        }
      }
    }

    function resetOverlay() {
      overlayText.innerHTML = "";
      overlayText.style.transform = "translateY(0px)";
      overlayText.style.opacity = 1;
      statusText.style.opacity = 1;
      statusText.textContent = "The Tree is Listening...";
    }

    function stopRecognition(recognition) {
      if (recognition) {
        try {
          recognition.onresult = null;
          recognition.onerror = null;
          recognition.onend = null;
          recognition.abort();
        } catch (e) {
          console.error("Error stopping recognition:", e);
        }
      }
    }

    function startWakeRecognition() {
      if (isPrompting) return;
      stopRecognition(wakeRecognition);
      wakeRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      wakeRecognition.lang = 'en-US';
      wakeRecognition.continuous = false;
      wakeRecognition.interimResults = false;

      wakeRecognition.onresult = (event) => {
        const speech = event.results[0][0].transcript.toLowerCase();
        console.log("Wake word heard:", speech);
        if (speech.includes("apple bark")) {
          stopRecognition(wakeRecognition);
          statusText.textContent = "Ask your question...";
          setTimeout(startPromptRecognition, 500);
        } else {
          restartWake();
        }
      };

      wakeRecognition.onerror = (event) => {
        console.error("Wake recognition error:", event.error);
        restartWake();
      };

      wakeRecognition.onend = () => {
        if (!isPrompting) restartWake();
      };

      try {
        wakeRecognition.start();
        console.log("Wake recognition started.");
      } catch (e) {
        console.error("Error starting wake recognition:", e);
        restartWake();
      }
    }

    function restartWake() {
      stopRecognition(wakeRecognition);
      setTimeout(startWakeRecognition, 500);
    }

    function startPromptRecognition() {
      console.log("Prompt recognition starting...");
      isPrompting = true;
      stopRecognition(promptRecognition);
      promptRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      promptRecognition.lang = 'en-US';
      promptRecognition.continuous = false;
      promptRecognition.interimResults = false;

      promptRecognition.onresult = (event) => {
        const userSpeech = event.results[0][0].transcript.toLowerCase();
        console.log("Prompt heard:", userSpeech);
        if (userSpeech.includes("give me a quest")) {
          loadRandomQuest();
        } else {
          generate(userSpeech);
        }
      };

      promptRecognition.onerror = (event) => {
        console.error("Prompt recognition error:", event.error);
        isPrompting = false;
        restartWake();
      };

      promptRecognition.onend = () => {
        isPrompting = false;
        restartWake();
      };

      try {
        promptRecognition.start();
        console.log("Prompt recognition started.");
      } catch (e) {
        console.error("Error starting prompt recognition:", e);
        isPrompting = false;
        restartWake();
      }
    }

    async function loadRandomQuest() {
      try {
        const response = await fetch('quests.json');
        const quests = await response.json();
        const quest = quests[Math.floor(Math.random() * quests.length)];
        generate(quest.prompt);
      } catch (e) {
        speakText("I'm afraid I cannot summon a quest right now.");
      }
    }

    function playRandomThinkingAudio() {
      if (!isThinking) return;
      let index;
      do {
        index = Math.floor(Math.random() * 10) + 1;
      } while (index === lastThinkingIndex);

      lastThinkingIndex = index;
      const audioFile = `tree-thinking-${index}.mp3`;

      thinkingAudio = new Audio(audioFile);
      thinkingAudio.play();

      thinkingAudio.onended = () => {
        if (isThinking) playRandomThinkingAudio();
      };

      thinkingAudio.onerror = () => {
        console.warn("Thinking audio error. Retrying...");
        if (isThinking) playRandomThinkingAudio();
      };
    }

    async function generate(prompt) {
      resetOverlay();
      statusText.textContent = "The Tree is Thinking...";
      statusText.style.opacity = 1;

      try {
        isThinking = true;
        playRandomThinkingAudio();
      } catch (e) {
        console.warn("Thinking audio could not start.");
      }

      await fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });

      pollUntilReady();
    }

    async function pollUntilReady() {
      try {
        const response = await fetch("/latest");
        const data = await response.json();
        if (data.text) {
          speakText(data.text);
        } else {
          setTimeout(pollUntilReady, 500);
        }
      } catch {
        setTimeout(pollUntilReady, 1000);
      }
    }

    function speakText(fullText) {
      overlayText.innerHTML = "";
      overlayText.style.opacity = 1;
      overlayText.style.transform = "translateY(0px)";
      statusText.style.opacity = 0;

      if (thinkingAudio) {
        isThinking = false;
        thinkingAudio.pause();
        thinkingAudio.currentTime = 0;
        thinkingAudio = null;
      }

      let index = 0;
      let scrollY = 0;

      clearInterval(scrollInterval);
      scrollInterval = setInterval(() => {
        scrollY -= 0.1;
        overlayText.style.transform = `translateY(${scrollY}px)`;
      }, 40);

      const displayInterval = setInterval(() => {
        if (index < fullText.length) {
          overlayText.innerHTML += fullText.charAt(index++);
        }
      }, 30);

      voiceAudio = new Audio(`latestAudio.mp3?cachebuster=${Date.now()}`);
      voiceAudio.play().catch(err => console.warn("Voice playback error:", err));
      voiceAudio.onpause = () => console.warn("Voice playback paused");
      voiceAudio.onended = () => {
        clearInterval(displayInterval);
        clearInterval(scrollInterval);
        overlayText.style.opacity = 0;
        setTimeout(resetOverlay, 2000);
      };
    }

    tapOverlay.addEventListener('click', () => {
      tapOverlay.style.opacity = 0;
      setTimeout(() => tapOverlay.remove(), 1000);
      requestWakeLock();
      startWakeRecognition();
    });
  </script>
</body>
</html>
